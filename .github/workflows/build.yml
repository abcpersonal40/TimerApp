name: TitanChart Pro Flutter Final Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'

      - name: Create Flutter Project & Add Dependencies
        run: |
          rm -rf ./* .target
          flutter create --org com.titanchart --project-name titanchart_pro .
          flutter pub add webview_flutter:^4.7.0
          # We are allowing the latest v6.x version but fixing the code to match it
          flutter pub add flutter_foreground_task:^6.2.0

      - name: Setup Android Manifest
        run: |
          cat > android/app/src/main/AndroidManifest.xml <<EOF
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.titanchart.titanchart_pro">
              <uses-permission android:name="android.permission.INTERNET"/>
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <uses-permission android:name="android.permission.WAKE_LOCK" />
              <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
              <!-- Required for Android 14+ -->
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_DATA_SYNC" />

              <application
                  android:label="TitanChart Pro"
                  android:name="\${applicationName}"
                  android:icon="@mipmap/ic_launcher">
                  
                  <meta-data
                      android:name="flutterEmbedding"
                      android:value="2" />

                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:launchMode="singleTop"
                      android:theme="@style/LaunchTheme"
                      android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|screenLayout|uiMode"
                      android:hardwareAccelerated="true"
                      android:windowSoftInputMode="adjustResize">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
                  
                  <service 
                      android:name="com.pravera.flutter_foreground_task.service.ForegroundService"
                      android:foregroundServiceType="dataSync"
                      android:exported="false" />
              </application>
          </manifest>
          EOF

      - name: Setup Flutter Main Code (Fixed for v6.5.0)
        run: |
          cat > lib/main.dart <<EOF
          import 'dart:async';
          import 'dart:isolate';
          import 'package:flutter/material.dart';
          import 'package:flutter_foreground_task/flutter_foreground_task.dart';
          import 'package:webview_flutter/webview_flutter.dart';

          void main() => runApp(const TitanApp());

          @pragma('vm:entry-point')
          void startCallback() {
            FlutterForegroundTask.setTaskHandler(MyTaskHandler());
          }

          class MyTaskHandler extends TaskHandler {
            // FIX: Added proper overrides for v6.5.0+
            
            @override
            Future<void> onStart(DateTime timestamp, SendPort? sendPort) async {
              // Task started
            }

            // This was the missing method causing the error
            @override
            void onRepeatEvent(DateTime timestamp, SendPort? sendPort) {
              // Periodic event
            }

            @override
            Future<void> onDestroy(DateTime timestamp, SendPort? sendPort) async {
              // Task destroyed
            }
            
            @override
            void onButtonPressed(String id) {}
            
            @override
            void onNotificationPressed() {
              FlutterForegroundTask.launchApp();
            }
          }

          class TitanApp extends StatefulWidget {
            const TitanApp({super.key});
            @override State<TitanApp> createState() => _TitanAppState();
          }

          class _TitanAppState extends State<TitanApp> {
            late final WebViewController _controller;

            @override
            void initState() {
              super.initState();
              _initForeground();
              _controller = WebViewController()
                ..setJavaScriptMode(JavaScriptMode.unrestricted)
                ..setBackgroundColor(const Color(0xFF0B0E14))
                ..addJavaScriptChannel('FlutterTimer', onMessageReceived: (msg) => _handleTimer(msg.message))
                ..loadHtmlString(_getHtml());
            }
            
            void _initForeground() {
              FlutterForegroundTask.init(
                androidNotificationOptions: AndroidNotificationOptions(
                  channelId: 'titan_timer',
                  channelName: 'Titan Timer Service',
                  channelImportance: NotificationChannelImportance.LOW,
                  priority: NotificationPriority.LOW,
                  iconData: const NotificationIconData(
                    resType: ResourceType.mipmap,
                    resPrefix: ResourcePrefix.ic,
                    name: 'launcher',
                  ),
                ),
                iosNotificationOptions: const IOSNotificationOptions(),
                foregroundTaskOptions: const ForegroundTaskOptions(
                  interval: 5000,
                  isOnceEvent: false,
                  autoRunOnBoot: true,
                  allowWakeLock: true,
                  allowWifiLock: true,
                ),
              );
            }

            Future<void> _handleTimer(String text) async {
              if (text == "STOP") {
                await FlutterForegroundTask.stopService();
                return;
              }
              
              if (await FlutterForegroundTask.isRunningService) {
                FlutterForegroundTask.updateService(
                  notificationTitle: 'TitanChart Pro',
                  notificationText: text,
                );
              } else {
                await FlutterForegroundTask.startService(
                  notificationTitle: 'TitanChart Pro',
                  notificationText: text,
                  callback: startCallback,
                );
              }
            }

            @override
            Widget build(BuildContext context) {
              return WithForegroundTask(
                child: MaterialApp(
                  debugShowCheckedModeBanner: false,
                  home: Scaffold(
                    backgroundColor: const Color(0xFF0B0E14), 
                    body: SafeArea(child: WebViewWidget(controller: _controller))
                  ),
                ),
              );
            }

            String _getHtml() => """
              <!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>
                body { background: #0b0e14; color: white; font-family: sans-serif; text-align: center; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 90vh; }
                .card { background: #161b22; padding: 30px; border-radius: 20px; border: 1px solid #30363d; width: 100%; max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
                input { width: 80%; padding: 15px; background: #0d1117; color: #7ee787; border: 1px solid #444; border-radius: 10px; font-size: 30px; text-align: center; margin-bottom: 20px; }
                button { width: 100%; padding: 18px; margin-top: 10px; border-radius: 12px; border: none; font-weight: bold; font-size: 18px; cursor: pointer; transition: 0.2s; }
                button:active { transform: scale(0.98); }
                .start { background: #238636; color: white; }
                .stop { background: #da3633; color: white; }
                #display { font-size: 80px; margin: 20px 0; font-family: monospace; color: #58a6ff; font-weight: bold; }
                h2 { color: #c9d1d9; margin-bottom: 30px; }
              </style></head><body>
              <div class="card">
                <h2>TitanChart Pro</h2>
                <input type="number" id="tInput" value="60">
                <div id="display">00</div>
                <button class="start" onclick="s()">START TIMER</button>
                <button class="stop" onclick="p()">STOP</button>
              </div>
              <script>
                let t, s_rem;
                function s() {
                  s_rem = parseInt(document.getElementById('tInput').value);
                  if(t) clearInterval(t);
                  
                  // Send initial state
                  FlutterTimer.postMessage("Running: " + s_rem + "s");
                  
                  t = setInterval(() => {
                    s_rem--;
                    document.getElementById('display').innerText = s_rem < 10 ? "0" + s_rem : s_rem;
                    FlutterTimer.postMessage("Remaining: " + s_rem + "s");
                    if(s_rem <= 0) { 
                      clearInterval(t); 
                      FlutterTimer.postMessage("Time Up!"); 
                      document.getElementById('display').innerText = "00";
                    }
                  }, 1000);
                }
                function p() { 
                  clearInterval(t); 
                  document.getElementById('display').innerText = "00"; 
                  FlutterTimer.postMessage("STOP"); 
                }
              </script></body></html>""";
          }
          EOF

      - name: Build and Sign APK
        run: |
          # 1. Generate Keystore
          keytool -genkey -v -keystore android/app/release-key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias key -storepass titan123456 -keypass titan123456 -dname "CN=Titan, O=Dev, C=BD"
          
          # 2. Create key.properties
          cat > android/key.properties <<EOF
          storePassword=titan123456
          keyPassword=titan123456
          keyAlias=key
          storeFile=release-key.jks
          EOF
          
          # 3. Modify build.gradle (Updated for modern Android standards)
          cat > android/app/build.gradle <<EOF
          plugins {
              id "com.android.application"
              id "kotlin-android"
              id "dev.flutter.flutter-gradle-plugin"
          }

          def keystoreProperties = new Properties()
          def keystorePropertiesFile = rootProject.file('key.properties')
          if (keystorePropertiesFile.exists()) {
              keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
          }

          android {
              namespace "com.titanchart.titanchart_pro"
              compileSdkVersion 34 
              ndkVersion flutter.ndkVersion

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }

              kotlinOptions {
                  jvmTarget = '1.8'
              }

              sourceSets {
                  main.java.srcDirs += 'src/main/kotlin'
              }

              defaultConfig {
                  applicationId "com.titanchart.titanchart_pro"
                  minSdkVersion 23
                  targetSdkVersion 34
                  versionCode 1
                  versionName "1.0"
              }

              signingConfigs {
                  release {
                      storeFile file('release-key.jks')
                      storePassword 'titan123456'
                      keyAlias 'key'
                      keyPassword 'titan123456'
                  }
              }

              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                      minifyEnabled false
                      shrinkResources false
                  }
              }
          }

          flutter {
              source '../..'
          }
          EOF
          
          # Fix settings.gradle to ensure plugins are loaded correctly
          cat > android/settings.gradle <<EOF
          pluginManagement {
              def flutterSdkPath = {
                  def properties = new Properties()
                  file("local.properties").withInputStream { properties.load(it) }
                  def flutterSdkPath = properties.getProperty("flutter.sdk")
                  assert flutterSdkPath != null, "flutter.sdk not set in local.properties"
                  return flutterSdkPath
              }()

              includeBuild("\$flutterSdkPath/packages/flutter_tools/gradle")

              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }

          plugins {
              id "dev.flutter.flutter-plugin-loader" version "1.0.0"
              id "com.android.application" version "7.3.0" apply false
              id "org.jetbrains.kotlin.android" version "1.7.10" apply false
          }

          include ":app"
          EOF

          flutter build apk --release

      - name: Upload Final APK
        uses: actions/upload-artifact@v4
        with:
          name: TitanChart-Pro-Final-APK
          path: build/app/outputs/flutter-apk/app-release.apk
