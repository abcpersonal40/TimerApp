name: TitanChart Pro Final Signed Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js and Java
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Create Project Files
        run: |
          mkdir -p www
          # 1. package.json
          cat > package.json <<EOF
          {
            "name": "com.titanchart.pro",
            "version": "1.0.0",
            "dependencies": {
              "@capacitor/android": "^5.0.0",
              "@capacitor/core": "^5.0.0",
              "@capacitor/local-notifications": "^5.0.0",
              "@capacitor/haptics": "^5.0.0"
            },
            "devDependencies": {
              "@capacitor/cli": "^5.0.0"
            }
          }
          EOF

          # 2. capacitor.config.json
          cat > capacitor.config.json <<EOF
          {
            "appId": "com.titanchart.pro",
            "appName": "TitanChartPro",
            "webDir": "www",
            "bundledWebRuntime": false
          }
          EOF

          # 3. www/index.html (Media Controls Logic Included)
          cat > www/index.html <<EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>TitanChart Pro</title>
              <style>
                  body { background: #0D1117; color: white; font-family: sans-serif; padding: 20px; text-align: center; }
                  .card { background: #161B22; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #30363D; }
                  button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; font-size: 16px; background: #238636; color: white; font-weight: bold; }
                  input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #30363D; background: #0D1117; color: white; box-sizing: border-box; }
                  .timer-val { font-size: 50px; color: #7EE787; font-family: monospace; }
              </style>
          </head>
          <body>
              <h2>TitanChart Pro</h2>
              <div class="card">
                  <h3>Timer Controller</h3>
                  <input type="number" id="tInput" value="60">
                  <button onclick="startT()">Start Timer</button>
                  <div id="tDisplay" class="timer-val">0</div>
                  <p id="tStatus">Status: Idle</p>
              </div>
              <script src="https://unpkg.com/@capacitor/core@5.0.0/dist/index.js"></script>
              <script>
                  const { LocalNotifications } = Capacitor.Plugins;
                  let timeLeft = 0, isPaused = false, interval = null;
                  async function init() {
                      await LocalNotifications.requestPermissions();
                      await LocalNotifications.registerActionTypes({
                          types: [{ id: 'MEDIA', actions: [{id:'pause',title:'PAUSE'},{id:'play',title:'PLAY'},{id:'stop',title:'STOP'}] }]
                      });
                  }
                  init();
                  function startT() {
                      timeLeft = parseInt(document.getElementById('tInput').value);
                      isPaused = false;
                      if(interval) clearInterval(interval);
                      interval = setInterval(async () => {
                          if(!isPaused) { timeLeft--; updateUI(); updateNotif(); }
                          if(timeLeft <= 0) { clearInterval(interval); finish(); }
                      }, 1000);
                  }
                  function updateUI() {
                      document.getElementById('tDisplay').innerText = timeLeft;
                      document.getElementById('tStatus').innerText = isPaused ? "Paused" : "Running";
                  }
                  async function updateNotif() {
                      await LocalNotifications.schedule({
                          notifications: [{ title: isPaused?"Paused":"Running", body: "Time Left: "+timeLeft+"s", id: 1, ongoing: true, actionTypeId: 'MEDIA' }]
                      });
                  }
                  function finish() { LocalNotifications.schedule({ notifications: [{title:"Finished", body:"Timer Ended", id:1}] }); }
                  LocalNotifications.addListener('localNotificationActionPerformed', (e) => {
                      if(e.actionId==='pause') isPaused=true;
                      else if(e.actionId==='play') isPaused=false;
                      else if(e.actionId==='stop') { timeLeft=0; clearInterval(interval); LocalNotifications.cancel({notifications:[{id:1}]}); }
                      updateUI(); updateNotif();
                  });
              </script>
          </body>
          </html>
          EOF

      - name: Install Dependencies
        run: |
          npm install
          npx cap add android
          npx cap sync

      - name: Android Manifest & Gradle Fix
        run: |
          # Permissions
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.INTERNET" />' $MANIFEST
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" />' $MANIFEST
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />' $MANIFEST
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />' $MANIFEST
          # Cleartext traffic (HTTP) support
          sed -i 's/<application/<application android:usesCleartextTraffic="true"/' $MANIFEST
        shell: bash

      - name: Generate Keystore
        run: |
          keytool -genkey -v \
            -keystore android/app/release.keystore \
            -alias "titanchart" \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storetype JKS \
            -dname "CN=Titan, O=Dev, C=BD" \
            -storepass "titan123456" \
            -keypass "titan123456"

      - name: Configure Signing in Gradle
        run: |
          cat >> android/app/build.gradle <<EOF
          android {
              signingConfigs {
                  release {
                      storeFile file("release.keystore")
                      storePassword "titan123456"
                      keyAlias "titanchart"
                      keyPassword "titan123456"
                      v1SigningEnabled true
                      v2SigningEnabled true
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                      minifyEnabled false
                      shrinkResources false
                  }
              }
          }
          EOF

      - name: Build Signed APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease

      - name: Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: TitanChartPro-Signed-APK
          path: android/app/build/outputs/apk/release/app-release.apk
