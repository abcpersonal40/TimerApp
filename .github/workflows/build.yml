name: TitanChart Pro Custom Foreground Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js and Java
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Create Project structure
        run: |
          mkdir -p www
          mkdir -p android/app/src/main/java/com/titanchart/pro/foreground/
          
          # 1. package.json
          cat > package.json <<EOF
          {
            "name": "com.titanchart.pro",
            "version": "1.0.0",
            "dependencies": {
              "@capacitor/android": "^5.0.0",
              "@capacitor/core": "^5.0.0"
            },
            "devDependencies": {
              "@capacitor/cli": "^5.0.0"
            }
          }
          EOF

          # 2. capacitor.config.json
          cat > capacitor.config.json <<EOF
          {
            "appId": "com.titanchart.pro",
            "appName": "TitanChartPro",
            "webDir": "www",
            "bundledWebRuntime": false
          }
          EOF

      - name: Create Web Layer (index.html)
        run: |
          cat > www/index.html <<EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>TitanChart Pro</title>
              <style>
                  body { background: #0b0e14; color: white; font-family: sans-serif; text-align: center; padding: 50px; }
                  .card { background: #161b22; padding: 20px; border-radius: 15px; border: 1px solid #30363d; }
                  input { width: 80%; padding: 10px; margin: 10px; border-radius: 5px; }
                  button { width: 85%; padding: 12px; margin: 5px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; }
                  .btn-start { background: #238636; color: white; }
                  .btn-stop { background: #da3633; color: white; }
                  #display { font-size: 40px; margin: 20px; color: #58a6ff; }
              </style>
          </head>
          <body>
              <div class="card">
                  <h2>TitanChart Pro</h2>
                  <input type="number" id="secInput" value="60">
                  <div id="display">0</div>
                  <button class="btn-start" onclick="startTimer()">Start Foreground Timer</button>
                  <button class="btn-stop" onclick="stopTimer()">Stop</button>
              </div>

              <script src="https://unpkg.com/@capacitor/core@5.0.0/dist/index.js"></script>
              <script>
                  const { TimerService } = Capacitor.Plugins;
                  let timeLeft = 0;
                  let timerInt = null;

                  async function startTimer() {
                      timeLeft = parseInt(document.getElementById('secInput').value);
                      if(isNaN(timeLeft)) return;

                      // à§§. à¦•à¦¾à¦¸à§à¦Ÿà¦® à¦ªà§à¦²à¦¾à¦—à¦¿à¦¨ à¦¦à¦¿à§Ÿà§‡ à¦¸à¦¾à¦°à§à¦­à¦¿à¦¸ à¦¸à§à¦Ÿà¦¾à¦°à§à¦Ÿ
                      await TimerService.start({ text: timeLeft + " seconds remaining" });

                      if(timerInt) clearInterval(timerInt);
                      timerInt = setInterval(async () => {
                          timeLeft--;
                          document.getElementById('display').innerText = timeLeft;
                          
                          if(timeLeft <= 0) {
                              clearInterval(timerInt);
                              await TimerService.update({ text: "Time Up!" });
                          } else {
                              // à§¨. à¦ªà§à¦°à¦¤à¦¿ à¦¸à§‡à¦•à§‡à¦¨à§à¦¡à§‡ à¦¸à¦¾à¦‡à¦²à§‡à¦¨à§à¦Ÿ à¦†à¦ªà¦¡à§‡à¦Ÿ (à¦¨à§‹ à¦¬à§à¦²à¦¿à¦‚à¦•à¦¿à¦‚)
                              await TimerService.update({ text: timeLeft + " seconds remaining" });
                          }
                      }, 1000);
                  }

                  async function stopTimer() {
                      clearInterval(timerInt);
                      document.getElementById('display').innerText = "0";
                      await TimerService.stop();
                  }
              </script>
          </body>
          </html>
          EOF

      - name: Create Custom Android Plugin (Java)
        run: |
          PKG_PATH="android/app/src/main/java/com/titanchart/pro/foreground"
          
          # TimerService.java
          cat > $PKG_PATH/TimerService.java <<EOF
          package com.titanchart.pro.foreground;
          import android.app.*;
          import android.content.Intent;
          import android.os.IBinder;
          import android.os.Build;
          import androidx.core.app.NotificationCompat;

          public class TimerService extends Service {
              public static final String CHANNEL_ID = "TIMER_CHANNEL";
              public static final int NOTIF_ID = 101;

              @Override
              public void onCreate() {
                  super.onCreate();
                  createChannel();
                  TimerServiceHolder.service = this;
              }

              @Override
              public int onStartCommand(Intent intent, int flags, int startId) {
                  String text = intent.getStringExtra("text");
                  Notification notification = buildNotification(text != null ? text : "Timer running");
                  startForeground(NOTIF_ID, notification);
                  return START_STICKY;
              }

              public void update(String text) {
                  NotificationManager nm = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);
                  nm.notify(NOTIF_ID, buildNotification(text));
              }

              private Notification buildNotification(String text) {
                  return new NotificationCompat.Builder(this, CHANNEL_ID)
                          .setContentTitle("TitanChart Pro")
                          .setContentText(text)
                          .setSmallIcon(android.R.drawable.ic_media_play)
                          .setOngoing(true)
                          .setOnlyAlertOnce(true) // ðŸ”¥ à¦—à§à¦°à§à¦¤à§à¦¬à¦ªà§‚à¦°à§à¦£: à¦¬à§à¦²à¦¿à¦‚à¦• à¦†à¦Ÿà¦•à¦¾à¦¬à§‡
                          .setPriority(NotificationCompat.PRIORITY_LOW)
                          .build();
              }

              @Override
              public IBinder onBind(Intent intent) { return null; }

              private void createChannel() {
                  if (Build.VERSION.SDK_INT >= 26) {
                      NotificationChannel channel = new NotificationChannel(CHANNEL_ID, "Timer", NotificationManager.IMPORTANCE_LOW);
                      channel.setSound(null, null);
                      getSystemService(NotificationManager.class).createNotificationChannel(channel);
                  }
              }
          }
          EOF

          # TimerServiceHolder.java
          cat > $PKG_PATH/TimerServiceHolder.java <<EOF
          package com.titanchart.pro.foreground;
          public class TimerServiceHolder { public static TimerService service; }
          EOF

          # TimerPlugin.java
          cat > $PKG_PATH/TimerPlugin.java <<EOF
          package com.titanchart.pro.foreground;
          import android.content.Intent;
          import com.getcapacitor.*;
          import com.getcapacitor.annotation.CapacitorPlugin;

          @CapacitorPlugin(name = "TimerService")
          public class TimerPlugin extends Plugin {
              @PluginMethod
              public void start(PluginCall call) {
                  String text = call.getString("text");
                  Intent i = new Intent(getContext(), TimerService.class);
                  i.putExtra("text", text);
                  getContext().startForegroundService(i);
                  call.resolve();
              }

              @PluginMethod
              public void update(PluginCall call) {
                  String text = call.getString("text");
                  if (TimerServiceHolder.service != null) {
                      TimerServiceHolder.service.update(text);
                  }
                  call.resolve();
              }

              @PluginMethod
              public void stop(PluginCall call) {
                  getContext().stopService(new Intent(getContext(), TimerService.class));
                  call.resolve();
              }
          }
          EOF

      - name: Install Dependencies and Cap Sync
        run: |
          npm install
          npx cap add android
          npx cap sync

      - name: Register Plugin in MainActivity
        run: |
          MAIN_ACTIVITY="android/app/src/main/java/com/titanchart/pro/MainActivity.java"
          # MainActivity à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à§‡ à¦ªà§à¦²à¦¾à¦—à¦¿à¦¨ à¦°à§‡à¦œà¦¿à¦¸à§à¦Ÿà¦¾à¦° à¦•à¦°à¦¾
          cat > $MAIN_ACTIVITY <<EOF
          package com.titanchart.pro;
          import android.os.Bundle;
          import com.getcapacitor.BridgeActivity;
          import com.titanchart.pro.foreground.TimerPlugin;

          public class MainActivity extends BridgeActivity {
              @Override
              public void onCreate(Bundle savedInstanceState) {
                  registerPlugin(TimerPlugin.class);
                  super.onCreate(savedInstanceState);
              }
          }
          EOF

      - name: Android Manifest & Permissions
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          # Permissions
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />' $MANIFEST
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK" />' $MANIFEST
          
          # Service Declaration
          sed -i '/<application/a \        <service android:name=".foreground.TimerService" android:exported="false" android:foregroundServiceType="mediaPlayback" />' $MANIFEST
        shell: bash

      - name: Build Release APK
        run: |
          # à¦•à¦¿-à¦¸à§à¦Ÿà§‹à¦° à¦œà§‡à¦¨à¦¾à¦°à§‡à¦Ÿ
          keytool -genkey -v -keystore android/app/release.keystore -alias "titan" -keyalg RSA -keysize 2048 -validity 10000 -storetype JKS -dname "CN=Titan, O=Dev, C=BD" -storepass "titan123456" -keypass "titan123456"
          
          # à¦—à§à¦°à§‡à¦¡à¦² à¦•à¦¨à¦«à¦¿à¦—
          cat >> android/app/build.gradle <<EOF
          android {
              signingConfigs {
                  release {
                      storeFile file("release.keystore")
                      storePassword "titan123456"
                      keyAlias "titan"
                      keyPassword "titan123456"
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          EOF
          
          cd android && chmod +x gradlew && ./gradlew assembleRelease

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TitanChart-Foreground-Plugin-APK
          path: android/app/build/outputs/apk/release/app-release.apk
