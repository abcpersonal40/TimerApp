name: TitanChart Pro Stable Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js and Java
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Cleanup and Initial Setup
        run: |
          rm -rf android  # পুরনো ফোল্ডার থাকলে মুছে ফেলবে যাতে এরর না আসে
          mkdir -p www
          
          cat > package.json <<EOF
          {
            "name": "com.titanchart.pro",
            "version": "1.0.0",
            "dependencies": {
              "@capacitor/android": "^5.0.0",
              "@capacitor/core": "^5.0.0"
            },
            "devDependencies": {
              "@capacitor/cli": "^5.0.0"
            }
          }
          EOF

          cat > capacitor.config.json <<EOF
          {
            "appId": "com.titanchart.pro",
            "appName": "TitanChartPro",
            "webDir": "www",
            "bundledWebRuntime": false
          }
          EOF

      - name: Create Web Layer (index.html)
        run: |
          cat > www/index.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>TitanChart Pro</title>
              <style>
                  body { background: #0b0e14; color: white; font-family: sans-serif; text-align: center; padding: 30px; }
                  .card { background: #161b22; padding: 25px; border-radius: 20px; border: 1px solid #30363d; }
                  input { width: 80%; padding: 12px; margin: 15px; border-radius: 10px; background: #0d1117; color: white; font-size: 18px; border: 1px solid #333; }
                  button { width: 90%; padding: 15px; margin: 8px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
                  .btn-start { background: #238636; color: white; }
                  .btn-stop { background: #da3633; color: white; }
                  #display { font-size: 60px; margin: 25px; color: #7ee787; font-family: monospace; }
              </style>
          </head>
          <body>
              <div class="card">
                  <h2 style="color: #58a6ff;">TitanChart Pro</h2>
                  <input type="number" id="secInput" value="60">
                  <div id="display">00</div>
                  <button class="btn-start" onclick="startTimer()">START TIMER</button>
                  <button class="btn-stop" onclick="stopTimer()">STOP</button>
              </div>
              <script src="https://unpkg.com/@capacitor/core@5.0.0/dist/index.js"></script>
              <script>
                  const { TimerService } = Capacitor.Plugins;
                  let timeLeft = 0;
                  let timerInt = null;

                  async function startTimer() {
                      timeLeft = parseInt(document.getElementById('secInput').value);
                      if(isNaN(timeLeft)) return;
                      await TimerService.start({ text: "Remaining: " + timeLeft + "s" });
                      if(timerInt) clearInterval(timerInt);
                      timerInt = setInterval(async () => {
                          timeLeft--;
                          document.getElementById('display').innerText = timeLeft;
                          if(timeLeft <= 0) {
                              clearInterval(timerInt);
                              await TimerService.update({ text: "Time Up!" });
                          } else {
                              await TimerService.update({ text: "Remaining: " + timeLeft + "s" });
                          }
                      }, 1000);
                  }

                  async function stopTimer() {
                      clearInterval(timerInt);
                      document.getElementById('display').innerText = "00";
                      await TimerService.stop();
                  }
              </script>
          </body>
          </html>
          EOF

      - name: Install and Initialize Android
        run: |
          npm install
          npx cap add android
          npx cap sync

      - name: Create Custom Android Plugin & Service
        run: |
          PKG_PATH="android/app/src/main/java/com/titanchart/pro/foreground"
          mkdir -p $PKG_PATH
          
          # 1. TimerService.java
          cat > $PKG_PATH/TimerService.java <<EOF
          package com.titanchart.pro.foreground;
          import android.app.*;
          import android.content.Intent;
          import android.os.IBinder;
          import android.os.Build;
          import androidx.core.app.NotificationCompat;

          public class TimerService extends Service {
              public static final String CHANNEL_ID = "TIMER_CHANNEL";
              public static final int NOTIF_ID = 101;
              @Override
              public void onCreate() {
                  super.onCreate();
                  createChannel();
                  TimerServiceHolder.service = this;
              }
              @Override
              public int onStartCommand(Intent intent, int flags, int startId) {
                  String text = intent.getStringExtra("text");
                  startForeground(NOTIF_ID, buildNotif(text != null ? text : "Running..."));
                  return START_STICKY;
              }
              public void update(String text) {
                  NotificationManager nm = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);
                  nm.notify(NOTIF_ID, buildNotif(text));
              }
              private Notification buildNotif(String text) {
                  return new NotificationCompat.Builder(this, CHANNEL_ID)
                          .setContentTitle("TitanChart Timer")
                          .setContentText(text)
                          .setSmallIcon(android.R.drawable.ic_media_play)
                          .setOngoing(true)
                          .setOnlyAlertOnce(true)
                          .build();
              }
              @Override
              public IBinder onBind(Intent intent) { return null; }
              private void createChannel() {
                  if (Build.VERSION.SDK_INT >= 26) {
                      NotificationChannel c = new NotificationChannel(CHANNEL_ID, "Timer", NotificationManager.IMPORTANCE_LOW);
                      c.setSound(null, null);
                      getSystemService(NotificationManager.class).createNotificationChannel(c);
                  }
              }
          }
          EOF

          # 2. TimerServiceHolder.java
          cat > $PKG_PATH/TimerServiceHolder.java <<EOF
          package com.titanchart.pro.foreground;
          public class TimerServiceHolder { public static TimerService service; }
          EOF

          # 3. TimerPlugin.java
          cat > $PKG_PATH/TimerPlugin.java <<EOF
          package com.titanchart.pro.foreground;
          import android.content.Intent;
          import com.getcapacitor.*;
          import com.getcapacitor.annotation.CapacitorPlugin;

          @CapacitorPlugin(name = "TimerService")
          public class TimerPlugin extends Plugin {
              @PluginMethod
              public void start(PluginCall call) {
                  Intent i = new Intent(getContext(), TimerService.class);
                  i.putExtra("text", call.getString("text"));
                  getContext().startForegroundService(i);
                  call.resolve();
              }
              @PluginMethod
              public void update(PluginCall call) {
                  if (TimerServiceHolder.service != null) TimerServiceHolder.service.update(call.getString("text"));
                  call.resolve();
              }
              @PluginMethod
              public void stop(PluginCall call) {
                  getContext().stopService(new Intent(getContext(), TimerService.class));
                  call.resolve();
              }
          }
          EOF

      - name: Update MainActivity
        run: |
          MAIN_ACTIVITY="android/app/src/main/java/com/titanchart/pro/MainActivity.java"
          cat > $MAIN_ACTIVITY <<EOF
          package com.titanchart.pro;
          import android.os.Bundle;
          import com.getcapacitor.BridgeActivity;
          import com.titanchart.pro.foreground.TimerPlugin;

          public class MainActivity extends BridgeActivity {
              @Override
              public void onCreate(Bundle savedInstanceState) {
                  registerPlugin(TimerPlugin.class);
                  super.onCreate(savedInstanceState);
              }
          }
          EOF

      - name: Android Manifest Update
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          # Permissions
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />' $MANIFEST
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />' $MANIFEST
          # Service tag inside <application>
          sed -i '/<application/a \        <service android:name=".foreground.TimerService" android:exported="false" android:foregroundServiceType="specialUse" />' $MANIFEST

      - name: Build Release APK
        run: |
          keytool -genkey -v -keystore android/app/release.keystore -alias "titan" -keyalg RSA -keysize 2048 -validity 10000 -storetype JKS -dname "CN=Titan, O=Dev, C=BD" -storepass "titan123456" -keypass "titan123456"
          
          cat >> android/app/build.gradle <<EOF
          android {
              signingConfigs {
                  release {
                      storeFile file("release.keystore")
                      storePassword "titan123456"
                      keyAlias "titan"
                      keyPassword "titan123456"
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          EOF
          
          cd android && chmod +x gradlew && ./gradlew assembleRelease

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TitanChart-Stable-APK
          path: android/app/build/outputs/apk/release/app-release.apk
