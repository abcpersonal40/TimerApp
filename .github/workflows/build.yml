name: TitanChart Pro Flutter WebView Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'

      - name: Create Flutter Project
        run: |
          # সব পুরনো ফাইল মুছে নতুন প্রজেক্ট তৈরি
          rm -rf ./* .target
          flutter create --org com.titanchart --project-name titanchart_pro .
          
          # প্রয়োজনীয় প্যাকেজ অ্যাড করা
          flutter pub add webview_flutter flutter_foreground_task

      - name: Overwrite Android Manifest (Permissions & Service)
        run: |
          cat > android/app/src/main/AndroidManifest.xml <<EOF
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET"/>
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_SPECIAL_USE" />
              <uses-permission android:name="android.permission.WAKE_LOCK" />
              
              <application
                  android:label="TitanChart Pro"
                  android:name="\${applicationName}"
                  android:icon="@mipmap/ic_launcher">
                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:launchMode="singleTop"
                      android:theme="@style/LaunchTheme"
                      android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|screenLayout|uiMode"
                      android:hardwareAccelerated="true"
                      android:windowSoftInputMode="adjustResize">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
                  <service android:name="com.pravera.flutter_foreground_task.service.ForegroundService" android:exported="false" />
              </application>
          </manifest>
          EOF

      - name: Create Main Flutter Code (lib/main.dart)
        run: |
          cat > lib/main.dart <<EOF
          import 'dart:async';
          import 'package:flutter/material.dart';
          import 'package:flutter_foreground_task/flutter_foreground_task.dart';
          import 'package:webview_flutter/webview_flutter.dart';

          void main() => runApp(const TitanApp());

          // কাস্টম নোটিফিকেশন হ্যান্ডলার
          @pragma('vm:entry-point')
          void startCallback() {
            FlutterForegroundTask.setTaskHandler(MyTaskHandler());
          }

          class MyTaskHandler extends TaskHandler {
            @override
            void onStart(DateTime timestamp, SendPort? sendPort) async {}
            @override
            void onRepeatEvent(DateTime timestamp, SendPort? sendPort) async {}
            @override
            void onDestroy(DateTime timestamp, SendPort? sendPort) async {}
          }

          class TitanApp extends StatefulWidget {
            const TitanApp({super.key});
            @override
            State<TitanApp> createState() => _TitanAppState();
          }

          class _TitanAppState extends State<TitanApp> {
            late final WebViewController _controller;

            @override
            void initState() {
              super.initState();
              _initForegroundTask();
              
              _controller = WebViewController()
                ..setJavaScriptMode(JavaScriptMode.unrestricted)
                ..addJavaScriptChannel('FlutterTimer', onMessageReceived: (message) {
                  _updateNotification(message.message);
                })
                ..loadHtmlString(_getHtmlContent());
            }

            void _initForegroundTask() {
              FlutterForegroundTask.init(
                androidNotificationOptions: AndroidNotificationOptions(
                  channelId: 'timer_channel',
                  channelName: 'Timer Notification',
                  channelDescription: 'TitanChart Timer Running',
                  channelImportance: NotificationChannelImportance.LOW,
                  priority: NotificationPriority.LOW,
                  iconData: const NotificationIconData(resType: ResourceType.mipmap, resPrefix: ResourcePrefix.ic, name: 'launcher'),
                ),
                iosNotificationOptions: const IOSNotificationOptions(),
                foregroundTaskOptions: const ForegroundTaskOptions(interval: 5000, isOnceEvent: false, autoRunOnBoot: true, allowWakeLock: true),
              );
            }

            Future<void> _updateNotification(String text) async {
              if (await FlutterForegroundTask.isRunningService) {
                FlutterForegroundTask.updateService(notificationTitle: 'TitanChart Pro', notificationText: text);
              } else {
                await FlutterForegroundTask.startService(notificationTitle: 'TitanChart Pro', notificationText: text, callback: startCallback);
              }
              if (text == "STOP") await FlutterForegroundTask.stopService();
            }

            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                debugShowCheckedModeBanner: false,
                home: Scaffold(
                  backgroundColor: const Color(0xFF0B0E14),
                  body: SafeArea(child: WebViewWidget(controller: _controller)),
                ),
              );
            }

            String _getHtmlContent() {
              return """
              <!DOCTYPE html>
              <html>
              <head>
                <style>
                  body { background: #0b0e14; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
                  .card { background: #161b22; padding: 30px; border-radius: 20px; border: 1px solid #30363d; margin-top: 40px; }
                  input { width: 80%; padding: 15px; background: #0d1117; color: #7ee787; border: 1px solid #444; border-radius: 10px; font-size: 30px; text-align: center; }
                  button { width: 90%; padding: 15px; margin-top: 15px; border-radius: 10px; border: none; font-weight: bold; font-size: 18px; cursor: pointer; }
                  .start { background: #238636; color: white; }
                  .stop { background: #da3633; color: white; }
                  #display { font-size: 80px; margin: 30px; font-family: monospace; color: #58a6ff; }
                </style>
              </head>
              <body>
                <div class="card">
                  <h2>TitanChart Pro</h2>
                  <input type="number" id="timerInput" value="60">
                  <div id="display">00</div>
                  <button class="start" onclick="startTimer()">START TIMER</button>
                  <button class="stop" onclick="stopTimer()">STOP</button>
                </div>
                <script>
                  let timer;
                  let seconds;
                  function startTimer() {
                    seconds = parseInt(document.getElementById('timerInput').value);
                    if(timer) clearInterval(timer);
                    timer = setInterval(() => {
                      seconds--;
                      document.getElementById('display').innerText = seconds;
                      FlutterTimer.postMessage("Time Remaining: " + seconds + "s");
                      if(seconds <= 0) {
                        clearInterval(timer);
                        FlutterTimer.postMessage("Time is up!");
                      }
                    }, 1000);
                  }
                  function stopTimer() {
                    clearInterval(timer);
                    document.getElementById('display').innerText = "00";
                    FlutterTimer.postMessage("STOP");
                  }
                </script>
              </body>
              </html>
              """;
            }
          }
          EOF

      - name: Build Release APK
        run: |
          # কি-স্টোর জেনারেট
          keytool -genkey -v -keystore android/app/release-key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias key -storepass titan123456 -keypass titan123456 -dname "CN=Titan, O=Dev, C=BD"
          
          # কি-স্টোর কনফিগ
          cat > android/key.properties <<EOF
          storePassword=titan123456
          keyPassword=titan123456
          keyAlias=key
          storeFile=release-key.jks
          EOF
          
          # Gradle আপডেট সাইনিং এর জন্য
          sed -i 's/signingConfig signingConfigs.debug/signingConfig signingConfigs.release/' android/app/build.gradle
          
          flutter build apk --release

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: TitanChart-Flutter-WebView-APK
          path: build/app/outputs/flutter-apk/app-release.apk
