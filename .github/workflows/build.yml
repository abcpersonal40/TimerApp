name: TitanChart Pro Premium Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js and Java
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Create Project Files
        run: |
          mkdir -p www
          # 1. package.json
          cat > package.json <<EOF
          {
            "name": "com.titanchart.pro",
            "version": "1.0.0",
            "dependencies": {
              "@capacitor/android": "^5.0.0",
              "@capacitor/core": "^5.0.0",
              "@capacitor/local-notifications": "^5.0.0",
              "@capacitor/haptics": "^5.0.0"
            },
            "devDependencies": {
              "@capacitor/cli": "^5.0.0"
            }
          }
          EOF

          # 2. capacitor.config.json
          cat > capacitor.config.json <<EOF
          {
            "appId": "com.titanchart.pro",
            "appName": "TitanChartPro",
            "webDir": "www",
            "bundledWebRuntime": false
          }
          EOF

          # 3. www/index.html (Update logic for Silent Media-style notification)
          cat > www/index.html <<EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>TitanChart Pro</title>
              <style>
                  :root {
                      --bg: #0b0e14;
                      --card-bg: #161b22;
                      --accent: #58a6ff;
                      --green: #238636;
                      --red: #da3633;
                      --purple: #8957e5;
                  }
                  body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; padding: 20px; margin: 0; }
                  h1 { color: var(--accent); text-align: center; font-size: 24px; }
                  
                  .input-group { background: var(--card-bg); padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #30363d; }
                  input { width: calc(100% - 24px); padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #30363d; background: #0d1117; color: white; }
                  button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; }
                  
                  .btn-add { background: var(--accent); margin-top: 10px; }
                  .btn-alarm { background: var(--purple); }

                  .timer-card { background: #1c2128; padding: 20px; border-radius: 18px; margin-bottom: 15px; border-left: 5px solid var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
                  .timer-val { font-size: 35px; color: #7ee787; font-weight: bold; font-family: monospace; }
                  .timer-controls { display: flex; gap: 10px; margin-top: 15px; }
                  .pause { background: #f0883e; }
                  .stop { background: var(--red); }
                  .play { background: var(--green); }
              </style>
          </head>
          <body>
              <h1>TitanChart Pro</h1>

              <div class="input-group">
                  <h3>New Timer (Sec)</h3>
                  <input type="number" id="tInput" value="60">
                  <button class="btn-add" onclick="addTimer()">+ Start New Timer</button>
              </div>

              <div id="timersList"></div>

              <div class="input-group">
                  <h3>Set Alarm</h3>
                  <input type="time" id="aTime">
                  <button class="btn-alarm" onclick="addAlarm()">Set New Alarm</button>
              </div>

              <script src="https://unpkg.com/@capacitor/core@5.0.0/dist/index.js"></script>
              <script>
                  const { LocalNotifications } = Capacitor.Plugins;
                  let timers = {};

                  async function init() {
                      await LocalNotifications.requestPermissions();
                      // মিউজিক কন্ট্রোল এর মতো বাটন সেটআপ
                      await LocalNotifications.registerActionTypes({
                          types: [{ 
                              id: 'TIMER_ACTIONS', 
                              actions: [
                                  {id:'pause', title:'PAUSE'}, 
                                  {id:'play', title:'PLAY'}, 
                                  {id:'stop', title:'STOP', destructible: true}
                              ] 
                          }]
                      });
                  }
                  init();

                  function addTimer() {
                      const sec = parseInt(document.getElementById('tInput').value);
                      if (!sec) return;
                      const id = Math.floor(Math.random() * 10000);
                      timers[id] = { timeLeft: sec, paused: false, interval: null };
                      
                      const card = document.createElement('div');
                      card.className = 'timer-card';
                      card.id = 'card-' + id;
                      card.innerHTML = \`
                          <div style="display:flex; justify-content:space-between; align-items:center;">
                              <span>Timer #\${id}</span>
                              <div class="timer-val" id="val-\${id}">\${sec}</div>
                          </div>
                          <div class="timer-controls">
                              <button id="btn-p-\${id}" class="pause" onclick="toggleTimer(\${id})">Pause</button>
                              <button class="stop" onclick="stopTimer(\${id})">Stop</button>
                          </div>
                      \`;
                      document.getElementById('timersList').appendChild(card);
                      startInterval(id);
                  }

                  function startInterval(id) {
                      timers[id].interval = setInterval(() => {
                          if (!timers[id].paused) {
                              timers[id].timeLeft--;
                              document.getElementById('val-' + id).innerText = timers[id].timeLeft;
                              updateNotification(id);
                              
                              if (timers[id].timeLeft <= 0) {
                                  clearInterval(timers[id].interval);
                                  finishTimer(id);
                              }
                          }
                      }, 1000);
                  }

                  async function updateNotification(id) {
                      const t = timers[id];
                      // গুরুত্ব কমিয়ে (Importance low) দেওয়া হয়েছে যাতে পপ-আপ না হয়
                      await LocalNotifications.schedule({
                          notifications: [{
                              id: id,
                              title: t.paused ? "Paused: Timer #" + id : "Timer Running #" + id,
                              body: "Time remaining: " + t.timeLeft + "s",
                              ongoing: true, // সোয়াইপ করলে ডিলিট হবে না
                              autoCancel: false,
                              actionTypeId: 'TIMER_ACTIONS',
                              smallIcon: 'ic_stat_name', 
                              // Silent Update: নিচের লাইনগুলো পপ-আপ এবং শব্দ বন্ধ করবে
                              sound: null,
                              schedule: { allowWhileIdle: true },
                              extra: { "importance": 1, "priority": -2 } 
                          }]
                      });
                  }

                  function toggleTimer(id) {
                      timers[id].paused = !timers[id].paused;
                      const btn = document.getElementById('btn-p-' + id);
                      btn.innerText = timers[id].paused ? 'Play' : 'Pause';
                      btn.className = timers[id].paused ? 'play' : 'pause';
                      updateNotification(id);
                  }

                  function stopTimer(id) {
                      clearInterval(timers[id].interval);
                      const card = document.getElementById('card-' + id);
                      if(card) card.remove();
                      LocalNotifications.cancel({ notifications: [{ id: id }] });
                      delete timers[id];
                  }

                  async function finishTimer(id) {
                      await LocalNotifications.schedule({
                          notifications: [{ title: "Time Up!", body: "Timer #" + id + " has ended.", id: id + 20000 }]
                      });
                      stopTimer(id);
                  }

                  async function addAlarm() {
                      const time = document.getElementById('aTime').value;
                      if (!time) return;
                      const [h, m] = time.split(':');
                      const d = new Date(); d.setHours(h); d.setMinutes(m); d.setSeconds(0);
                      if (d <= new Date()) d.setDate(d.getDate() + 1);

                      await LocalNotifications.schedule({
                          notifications: [{
                              title: "ALARM", body: "Wake up! " + time,
                              id: Math.floor(Math.random()*1000), 
                              schedule: { at: d, allowWhileIdle: true },
                              sound: 'beep.wav'
                          }]
                      });
                      alert("Alarm set for " + time);
                  }

                  LocalNotifications.addListener('localNotificationActionPerformed', (e) => {
                      const id = e.notification.id;
                      if (!timers[id]) return;
                      if (e.actionId === 'pause' || e.actionId === 'play') toggleTimer(id);
                      else if (e.actionId === 'stop') stopTimer(id);
                  });
              </script>
          </body>
          </html>
          EOF

      - name: Install Dependencies
        run: |
          npm install
          npx cap add android
          npx cap sync

      - name: Android Manifest & Notification Config
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          # Permissions for background and alarms
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" />' $MANIFEST
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />' $MANIFEST
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />' $MANIFEST
        shell: bash

      - name: Generate Keystore
        run: |
          keytool -genkey -v -keystore android/app/release.keystore -alias "titan" -keyalg RSA -keysize 2048 -validity 10000 -storetype JKS -dname "CN=Titan, O=Dev, C=BD" -storepass "titan123456" -keypass "titan123456"

      - name: Configure Gradle
        run: |
          cat >> android/app/build.gradle <<EOF
          android {
              signingConfigs {
                  release {
                      storeFile file("release.keystore")
                      storePassword "titan123456"
                      keyAlias "titan"
                      keyPassword "titan123456"
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          EOF

      - name: Build Release APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TitanChartPro-Premium-APK
          path: android/app/build/outputs/apk/release/app-release.apk
