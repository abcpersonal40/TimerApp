name: TitanChart Media Style Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js and Java
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Create Project Files
        run: |
          mkdir -p www
          
          # 1. package.json
          cat > package.json <<EOF
          {
            "name": "com.titanchart.pro",
            "version": "1.0.0",
            "dependencies": {
              "@capacitor/android": "^5.0.0",
              "@capacitor/core": "^5.0.0",
              "@capacitor/local-notifications": "^5.0.0",
              "@capacitor/haptics": "^5.0.0"
            },
            "devDependencies": {
              "@capacitor/cli": "^5.0.0"
            }
          }
          EOF

          # 2. capacitor.config.json
          cat > capacitor.config.json <<EOF
          {
            "appId": "com.titanchart.pro",
            "appName": "TitanChartPro",
            "webDir": "www",
            "bundledWebRuntime": false
          }
          EOF

          # 3. www/index.html (Advanced Controller Logic)
          cat > www/index.html <<EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>TitanChart Pro</title>
              <style>
                  body { background: #0D1117; color: white; font-family: sans-serif; padding: 20px; text-align: center; }
                  .card { background: #161B22; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #30363D; }
                  input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; font-size: 16px; }
                  button { background: #238636; color: white; font-weight: bold; cursor: pointer; }
                  .timer-val { font-size: 40px; color: #7EE787; font-family: monospace; }
                  .status { font-size: 14px; color: #8b949e; margin-top: 10px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h2 style="color: #58A6FF;">TitanChart Pro</h2>
                  <div class="card">
                      <h3>Media Style Timer</h3>
                      <input type="number" id="tInput" placeholder="Seconds" value="60">
                      <button onclick="startNewTimer()">Start Timer</button>
                      <div id="timerDisplay" class="timer-val">0</div>
                      <div id="statusText" class="status">Status: Idle</div>
                  </div>
                  
                  <div class="card">
                      <h3>Exact Alarm</h3>
                      <input type="time" id="aTime">
                      <button style="background:#8957E5" onclick="setAlarm()">Set Alarm</button>
                  </div>
              </div>

              <script src="https://unpkg.com/@capacitor/core@5.0.0/dist/index.js"></script>
              <script>
                  const { LocalNotifications } = Capacitor.Plugins;
                  let timerId = 123;
                  let timeLeft = 0;
                  let isPaused = false;
                  let interval = null;

                  async function init() {
                      await LocalNotifications.requestPermissions();
                      
                      // ১. নোটিফিকেশন বাটন সেটআপ (Play, Pause, Stop)
                      await LocalNotifications.registerActionTypes({
                          types: [{
                              id: 'TIMER_CONTROLS',
                              actions: [
                                  { id: 'pause', title: 'PAUSE' },
                                  { id: 'resume', title: 'RESUME/PLAY' },
                                  { id: 'stop', title: 'STOP', destructible: true }
                              ]
                          }]
                      });
                  }
                  init();

                  function startNewTimer() {
                      timeLeft = parseInt(document.getElementById('tInput').value);
                      if(!timeLeft) return;
                      isPaused = false;
                      if(interval) clearInterval(interval);
                      runLogic();
                  }

                  function runLogic() {
                      interval = setInterval(async () => {
                          if (!isPaused) {
                              timeLeft--;
                              updateUI();
                              updateNotification();
                          }
                          if (timeLeft <= 0) {
                              clearInterval(interval);
                              finishTimer();
                          }
                      }, 1000);
                  }

                  function updateUI() {
                      document.getElementById('timerDisplay').innerText = timeLeft;
                      document.getElementById('statusText').innerText = isPaused ? "Paused" : "Running...";
                  }

                  async function updateNotification() {
                      await LocalNotifications.schedule({
                          notifications: [{
                              title: isPaused ? "Timer Paused" : "Timer Running...",
                              body: "Time Remaining: " + timeLeft + "s",
                              id: timerId,
                              ongoing: true,
                              actionTypeId: 'TIMER_CONTROLS'
                          }]
                      });
                  }

                  async function finishTimer() {
                      await LocalNotifications.schedule({
                          notifications: [{ title: "Time Up!", body: "Your timer has finished", id: timerId }]
                      });
                  }

                  // ২. নোটিফিকেশন বাটন ক্লিক হ্যান্ডলার (Play/Pause/Stop)
                  LocalNotifications.addListener('localNotificationActionPerformed', (payload) => {
                      const action = payload.actionId;
                      if (action === 'pause') {
                          isPaused = true;
                          updateUI();
                          updateNotification();
                      } else if (action === 'resume') {
                          isPaused = false;
                          updateUI();
                          updateNotification();
                      } else if (action === 'stop') {
                          timeLeft = 0;
                          isPaused = false;
                          clearInterval(interval);
                          updateUI();
                          LocalNotifications.cancel({ notifications: [{ id: timerId }] });
                      }
                  });

                  // ৩. অ্যালার্ম লজিক
                  async function setAlarm() {
                      const time = document.getElementById('aTime').value;
                      if (!time) return;
                      const [h, m] = time.split(':');
                      const d = new Date();
                      d.setHours(h); d.setMinutes(m); d.setSeconds(0);
                      if (d <= new Date()) d.setDate(d.getDate() + 1);

                      await LocalNotifications.schedule({
                          notifications: [{
                              title: "ALARM!", body: "Wake up! It is " + time,
                              id: 999,
                              schedule: { at: d, allowWhileIdle: true },
                              sound: 'beep.wav'
                          }]
                      });
                      alert("Alarm set!");
                  }
              </script>
          </body>
          </html>
          EOF

      - name: Install Dependencies
        run: |
          npm install
          npx cap add android
          npx cap sync

      - name: Inject Android Permissions
        run: |
          MANIFEST_PATH="android/app/src/main/AndroidManifest.xml"
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" />' $MANIFEST_PATH
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.USE_EXACT_ALARM" />' $MANIFEST_PATH
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />' $MANIFEST_PATH
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />' $MANIFEST_PATH
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.WAKE_LOCK" />' $MANIFEST_PATH
          sed -i 's/<application/<application android:usesCleartextTraffic="true"/' $MANIFEST_PATH
        shell: bash

      - name: Generate Keystore
        run: |
          keytool -genkey -v \
            -keystore android/app/release.keystore \
            -alias "titanchart" \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storetype JKS \
            -dname "CN=Titan, O=Dev, C=BD" \
            -storepass "titan123456" \
            -keypass "titan123456"

      - name: Configure Gradle
        run: |
          cat >> android/app/build.gradle <<EOF
          android {
              signingConfigs {
                  release {
                      storeFile file("release.keystore")
                      storePassword "titan123456"
                      keyAlias "titanchart"
                      keyPassword "titan123456"
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          EOF

      - name: Build Release APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TitanChartPro-Media-App
          path: android/app/build/outputs/apk/release/app-release.apk
